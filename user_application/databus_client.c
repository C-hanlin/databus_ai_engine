/**
 * databus_client.c - DataBus AI Engine ç”¨æˆ·ç©ºé—´å®¢æˆ·ç«¯ï¼ˆé«˜æ€§èƒ½AIæ•°æ®å¤„ç†ç¤ºä¾‹ï¼‰
 * 
 * ã€ç¨‹åºæ¦‚è¿°ã€‘
 * è¿™æ˜¯DataBus AI Engineçš„å®˜æ–¹ç”¨æˆ·ç©ºé—´å®¢æˆ·ç«¯ï¼Œå±•ç¤ºäº†å¦‚ä½•é«˜æ•ˆåœ°ä¸å†…æ ¸æ¨¡å—
 * è¿›è¡Œäº¤äº’ï¼Œå®ç°é›¶æ‹·è´ã€ä½å»¶è¿Ÿçš„AIæ•°æ®å¤„ç†ã€‚è¯¥ç¨‹åºæ˜¯ä¸€ä¸ªå®Œæ•´çš„å‚è€ƒå®ç°ï¼Œ
 * æ¶µç›–äº†ä»è®¾å¤‡åˆå§‹åŒ–åˆ°æ•°æ®å¤„ç†çš„å®Œæ•´å·¥ä½œæµç¨‹ã€‚
 * 
 * ğŸ¯ æ ¸å¿ƒåŠŸèƒ½ï¼š
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚ ğŸ”§ è®¾å¤‡ç®¡ç†                                             â”‚
 * â”‚   â”œâ”€â”€ è®¾å¤‡æ–‡ä»¶æ‰“å¼€å’Œæƒé™æ£€æŸ¥                            â”‚
 * â”‚   â”œâ”€â”€ è®¾å¤‡é…ç½®å’Œå‚æ•°éªŒè¯                                â”‚
 * â”‚   â””â”€â”€ ä¼˜é›…çš„èµ„æºæ¸…ç†å’Œé”™è¯¯æ¢å¤                          â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ ğŸš€ æ•°æ®æµæ§åˆ¶                                           â”‚
 * â”‚   â”œâ”€â”€ å¯åŠ¨/åœæ­¢æ•°æ®æµä¼ è¾“                               â”‚
 * â”‚   â”œâ”€â”€ å®æ—¶æµçŠ¶æ€ç›‘æ§                                    â”‚
 * â”‚   â””â”€â”€ åŠ¨æ€æµå‚æ•°è°ƒæ•´                                    â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ ğŸ’¾ å†…å­˜æ˜ å°„ç®¡ç†                                         â”‚
 * â”‚   â”œâ”€â”€ DMAç¼“å†²åŒºçš„mmapæ˜ å°„                               â”‚
 * â”‚   â”œâ”€â”€ ç¯å½¢ç¼“å†²åŒºæŒ‡é’ˆç®¡ç†                                â”‚
 * â”‚   â””â”€â”€ å†…å­˜è®¿é—®ä¼˜åŒ–å’Œç¼“å­˜ç­–ç•¥                            â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ ğŸ“Š AIæ•°æ®å¤„ç†                                           â”‚
 * â”‚   â”œâ”€â”€ å®æ—¶IMUä¼ æ„Ÿå™¨æ•°æ®è¯»å–                             â”‚
 * â”‚   â”œâ”€â”€ æ•°æ®åŒ…å®Œæ•´æ€§éªŒè¯                                  â”‚
 * â”‚   â”œâ”€â”€ æ—¶é—´æˆ³å’Œåºåˆ—å·ç®¡ç†                                â”‚
 * â”‚   â””â”€â”€ ç»Ÿè®¡åˆ†æå’Œæ€§èƒ½ç›‘æ§                                â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ âš¡ å¼‚æ­¥I/Oæ”¯æŒï¼ˆå¯é€‰ï¼‰                                   â”‚
 * â”‚   â”œâ”€â”€ io_uringå¼‚æ­¥è¯»å–                                  â”‚
 * â”‚   â”œâ”€â”€ æ‰¹é‡æ•°æ®å¤„ç†                                      â”‚
 * â”‚   â””â”€â”€ äº‹ä»¶é©±åŠ¨çš„æ•°æ®å¤„ç†                                â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * 
 * ğŸ—ï¸ æ¶æ„è®¾è®¡ï¼š
 * ç”¨æˆ·åº”ç”¨ â†â†’ è®¾å¤‡æ–‡ä»¶ â†â†’ å†…æ ¸æ¨¡å— â†â†’ DMAç¼“å†²åŒº â†â†’ ç¡¬ä»¶ä¼ æ„Ÿå™¨
 *     â†“         â†“          â†“          â†“           â†“
 *  ä¸šåŠ¡é€»è¾‘   ç³»ç»Ÿè°ƒç”¨   é©±åŠ¨ç¨‹åº   é›¶æ‹·è´ä¼ è¾“   æ•°æ®é‡‡é›†
 * 
 * ğŸ“ˆ æ€§èƒ½ç‰¹æ€§ï¼š
 * - é›¶æ‹·è´æ•°æ®è®¿é—®ï¼šç›´æ¥è¯»å–DMAç¼“å†²åŒºï¼Œé¿å…å†…å­˜æ‹·è´
 * - ä½å»¶è¿Ÿå¤„ç†ï¼šå¾®ç§’çº§æ•°æ®è®¿é—®å»¶è¿Ÿ
 * - é«˜ååé‡ï¼šæ”¯æŒGB/sçº§åˆ«çš„æ•°æ®ä¼ è¾“
 * - CPUå‹å¥½ï¼šæœ€å°åŒ–CPUå ç”¨ï¼Œé€‚åˆå®æ—¶ç³»ç»Ÿ
 * 
 * ğŸ”§ ç¼–è¯‘å’Œä½¿ç”¨ï¼š
 * ```bash
 * # ç¼–è¯‘
 * make -C user_application
 * 
 * # è¿è¡Œï¼ˆéœ€è¦rootæƒé™åŠ è½½å†…æ ¸æ¨¡å—ï¼‰
 * sudo insmod kernel_module/databus_ai.ko
 * sudo ./user_application/databus_client
 * 
 * # æ¸…ç†
 * sudo rmmod databus_ai
 * ```
 * 
 * ğŸ“‹ ä¾èµ–è¦æ±‚ï¼š
 * - Linuxå†…æ ¸ >= 5.1ï¼ˆio_uringæ”¯æŒï¼‰
 * - GCC >= 7.0ï¼ˆC11æ ‡å‡†æ”¯æŒï¼‰
 * - è®¾å¤‡æ–‡ä»¶æƒé™ï¼š/dev/databus_ai
 * - å†…å­˜ï¼šè‡³å°‘8MBå¯ç”¨å†…å­˜ç”¨äºDMAç¼“å†²åŒº
 */

#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <sys/ioctl.h>
#include <errno.h>
#include <signal.h>
#include <time.h>
// #include <liburing.h>  // æš‚æ—¶æ³¨é‡Šæ‰ï¼Œä½¿ç”¨æ ‡å‡†ç³»ç»Ÿè°ƒç”¨

#include "databus_shared.h"

// Global variables for cleanup
static int g_fd = -1;
static void *g_mapped_buffer = NULL;
static size_t g_mapped_size = 0;
// static struct io_uring g_ring;  // æš‚æ—¶æ³¨é‡Šæ‰
// static int g_ring_initialized = 0;
static volatile int g_running = 1;

// ä¿¡å·å¤„ç†å‡½æ•°ï¼Œç”¨äºä¼˜é›…å…³é—­ç¨‹åº
// å½“æ¥æ”¶åˆ°SIGINTæˆ–SIGTERMä¿¡å·æ—¶ï¼Œè®¾ç½®è¿è¡Œæ ‡å¿—ä¸ºfalse
void signal_handler(int sig)
{
    printf("\næ¥æ”¶åˆ°ä¿¡å· %dï¼Œæ­£åœ¨ä¼˜é›…å…³é—­ç¨‹åº...\n", sig);
    g_running = 0;  // è®¾ç½®è¿è¡Œæ ‡å¿—ä¸ºåœæ­¢çŠ¶æ€
}

// æ¸…ç†èµ„æºå‡½æ•°
// è´Ÿè´£é‡Šæ”¾æ‰€æœ‰å·²åˆ†é…çš„èµ„æºï¼ŒåŒ…æ‹¬åœæ­¢æ•°æ®æµã€å–æ¶ˆå†…å­˜æ˜ å°„ã€å…³é—­è®¾å¤‡ç­‰
void cleanup_resources(void)
{
    printf("æ­£åœ¨æ¸…ç†èµ„æº...\n");
    
    // åœæ­¢æ•°æ®æµä¼ è¾“
    if (g_fd >= 0) {
        if (ioctl(g_fd, DATABUS_IOCTL_STOP_STREAM, NULL) < 0) {
            perror("åœæ­¢æ•°æ®æµå¤±è´¥");
        }
    }
    
    // æ¸…ç†io_uringèµ„æº (æš‚æ—¶æ³¨é‡Šæ‰)
    // if (g_ring_initialized) {
    //     io_uring_queue_exit(&g_ring);
    //     g_ring_initialized = 0;
    // }
    
    // å–æ¶ˆå†…å­˜æ˜ å°„
    if (g_mapped_buffer && g_mapped_buffer != MAP_FAILED) {
        if (munmap(g_mapped_buffer, g_mapped_size) < 0) {
            perror("å–æ¶ˆå†…å­˜æ˜ å°„å¤±è´¥");
        }
        g_mapped_buffer = NULL;
    }
    
    // å…³é—­è®¾å¤‡æ–‡ä»¶
    if (g_fd >= 0) {
        close(g_fd);
        g_fd = -1;
    }
    
    printf("èµ„æºæ¸…ç†å®Œæˆã€‚\n");
}

// æ ¼å¼åŒ–æ—¶é—´æˆ³ç”¨äºæ˜¾ç¤º
// å°†çº³ç§’çº§æ—¶é—´æˆ³è½¬æ¢ä¸ºå¯è¯»çš„æ—¶é—´æ ¼å¼ (HH:MM:SS.nnnnnnnnn)
void format_timestamp(uint64_t timestamp_ns, char *buffer, size_t size)
{
    time_t seconds = timestamp_ns / 1000000000ULL;      // æå–ç§’æ•°éƒ¨åˆ†
    uint32_t nanoseconds = timestamp_ns % 1000000000ULL; // æå–çº³ç§’éƒ¨åˆ†
    struct tm *tm_info = localtime(&seconds);            // è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´ç»“æ„
    
    // æ ¼å¼åŒ–ä¸º æ—¶:åˆ†:ç§’.çº³ç§’ çš„å½¢å¼
    snprintf(buffer, size, "%02d:%02d:%02d.%09u",
             tm_info->tm_hour, tm_info->tm_min, tm_info->tm_sec, nanoseconds);
}

// æ˜¾ç¤ºæ•°æ®åŒ…ä¿¡æ¯
// æ ¼å¼åŒ–å¹¶æ‰“å°AIæ•°æ®åŒ…çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ—¶é—´æˆ³ã€åºåˆ—å·ã€IMUæ•°æ®å’Œå¼ é‡å°ºå¯¸
void display_packet_info(const struct ai_data_packet *pkt)
{
    char timestamp_str[32];  // æ—¶é—´æˆ³å­—ç¬¦ä¸²ç¼“å†²åŒº
    format_timestamp(pkt->timestamp_ns, timestamp_str, sizeof(timestamp_str));
    
    // æ‰“å°æ•°æ®åŒ…çš„å®Œæ•´ä¿¡æ¯
    printf("[%s] åºåˆ—: %u, IMU: åŠ é€Ÿåº¦(%d,%d,%d) é™€èºä»ª(%d,%d,%d), å¼ é‡: %ux%u\n",
           timestamp_str,
           pkt->sequence_id,
           pkt->accel_x, pkt->accel_y, pkt->accel_z,
           pkt->gyro_x, pkt->gyro_y, pkt->gyro_z,
           pkt->tensor_width, pkt->tensor_height);
}

/**
 * main() - DataBus AI Engineå®¢æˆ·ç«¯ä¸»ç¨‹åºå…¥å£
 * 
 * ã€ç¨‹åºæµç¨‹ã€‘
 * è¿™æ˜¯å®¢æˆ·ç«¯çš„æ ¸å¿ƒæ§åˆ¶æµç¨‹ï¼Œå®ç°äº†å®Œæ•´çš„AIæ•°æ®å¤„ç†ç”Ÿå‘½å‘¨æœŸï¼š
 * 1ï¸âƒ£ è®¾å¤‡åˆå§‹åŒ– â†’ 2ï¸âƒ£ å†…å­˜æ˜ å°„ â†’ 3ï¸âƒ£ æ•°æ®æµå¯åŠ¨ â†’ 4ï¸âƒ£ å®æ—¶å¤„ç† â†’ 5ï¸âƒ£ èµ„æºæ¸…ç†
 * 
 * ğŸ¯ è®¾è®¡ç›®æ ‡ï¼š
 * - å±•ç¤ºæœ€ä½³å®è·µçš„ç”¨æˆ·ç©ºé—´ç¼–ç¨‹æ¨¡å¼
 * - æä¾›å¯å¤ç”¨çš„ä»£ç æ¨¡æ¿
 * - å®ç°é«˜æ€§èƒ½çš„æ•°æ®å¤„ç†æµæ°´çº¿
 * - ç¡®ä¿èµ„æºå®‰å…¨å’Œé”™è¯¯æ¢å¤
 * 
 * ğŸ“Š æ€§èƒ½ç›‘æ§ï¼š
 * - å®æ—¶ååé‡ç»Ÿè®¡ï¼ˆpackets/secondï¼‰
 * - æ•°æ®å®Œæ•´æ€§éªŒè¯ï¼ˆåºåˆ—å·æ£€æŸ¥ï¼‰
 * - å»¶è¿Ÿæµ‹é‡å’Œæ€§èƒ½åˆ†æ
 * - å†…å­˜ä½¿ç”¨æƒ…å†µç›‘æ§
 * 
 * @param argc å‘½ä»¤è¡Œå‚æ•°ä¸ªæ•°
 * @param argv å‘½ä»¤è¡Œå‚æ•°æ•°ç»„
 * @return 0 æˆåŠŸï¼Œé0 å¤±è´¥
 */
int main(int argc, char *argv[])
{
    // ğŸ”§ æ ¸å¿ƒæ•°æ®ç»“æ„å£°æ˜
    struct databus_buffer_info buffer_info;   // ç¼“å†²åŒºé…ç½®ä¿¡æ¯ï¼ˆä»å†…æ ¸è·å–ï¼‰
    struct ring_buffer_header *ring_header;   // ç¯å½¢ç¼“å†²åŒºæ§åˆ¶å¤´éƒ¨ï¼ˆç”Ÿäº§è€…/æ¶ˆè´¹è€…æŒ‡é’ˆï¼‰
    struct ai_data_packet *packet_metadata;   // AIæ•°æ®åŒ…å…ƒæ•°æ®æ•°ç»„ï¼ˆIMU+å¼ é‡ä¿¡æ¯ï¼‰
    
    // ğŸ“ˆ å¤„ç†çŠ¶æ€å’Œç»Ÿè®¡å˜é‡
    uint32_t last_tail = 0;                   // ä¸Šæ¬¡å¤„ç†çš„æ¶ˆè´¹è€…æŒ‡é’ˆä½ç½®
    uint32_t packets_processed = 0;           // å½“å‰ç»Ÿè®¡å‘¨æœŸå†…å·²å¤„ç†æ•°æ®åŒ…è®¡æ•°
    time_t start_time, current_time;          // æ€§èƒ½ç»Ÿè®¡æ—¶é—´æˆ³å˜é‡
    
    printf("ğŸš€ DataBus AI å®¢æˆ·ç«¯åº”ç”¨ç¨‹åº\n");
    printf("=============================\n");
    printf("ğŸ“‹ ç‰ˆæœ¬: v1.0 | æ¨¡å¼: é«˜æ€§èƒ½å®æ—¶å¤„ç†\n");
    
    // ğŸ›¡ï¸ ä¿¡å·å¤„ç†å™¨è®¾ç½® - ç¡®ä¿ä¼˜é›…å…³é—­å’Œèµ„æºæ¸…ç†
    signal(SIGINT, signal_handler);   // Ctrl+C ä¸­æ–­ä¿¡å·
    signal(SIGTERM, signal_handler);  // ç»ˆæ­¢ä¿¡å·ï¼ˆsystemdç­‰å‘é€ï¼‰
    printf("ğŸ›¡ï¸ ä¿¡å·å¤„ç†å™¨å·²æ³¨å†Œï¼Œæ”¯æŒä¼˜é›…å…³é—­\n");
    
    // ğŸ”Œ 1. è®¾å¤‡æ–‡ä»¶æ‰“å¼€ - å»ºç«‹ä¸å†…æ ¸æ¨¡å—çš„é€šä¿¡é€šé“
    printf("ğŸ”Œ 1. æ­£åœ¨è¿æ¥DataBus AIè®¾å¤‡: %s\n", DATABUS_DEVICE_PATH);
    printf("   ğŸ“‹ è®¾å¤‡æ–‡ä»¶ä½œç”¨ï¼šç”¨æˆ·ç©ºé—´ä¸å†…æ ¸é©±åŠ¨çš„æ¡¥æ¢\n");
    printf("   ğŸ”§ æ‰“å¼€æ¨¡å¼ï¼šè¯»å†™æ¨¡å¼ (O_RDWR)\n");
    
    g_fd = open(DATABUS_DEVICE_PATH, O_RDWR);
    if (g_fd < 0) {
        fprintf(stderr, "âŒ è®¾å¤‡æ‰“å¼€å¤±è´¥: %s\n", DATABUS_DEVICE_PATH);
        fprintf(stderr, "ğŸ’¡ æ•…éšœæ’é™¤æŒ‡å—ï¼š\n");
        fprintf(stderr, "   1. æ£€æŸ¥å†…æ ¸æ¨¡å—: lsmod | grep databus\n");
        fprintf(stderr, "   2. æ£€æŸ¥è®¾å¤‡æ–‡ä»¶: ls -l /dev/databus*\n");
        fprintf(stderr, "   3. æ£€æŸ¥æƒé™: sudo ./databus_client\n");
        fprintf(stderr, "   4. æŸ¥çœ‹å†…æ ¸æ—¥å¿—: dmesg | tail\n");
        return EXIT_FAILURE;
    }
    printf("   âœ… è®¾å¤‡è¿æ¥æˆåŠŸ (æ–‡ä»¶æè¿°ç¬¦=%d)\n", g_fd);
    printf("   ğŸ”— ç”¨æˆ·ç©ºé—´ â†” å†…æ ¸ç©ºé—´é€šä¿¡é€šé“å·²å»ºç«‹\n");
    
    // ğŸ’¾ 2. ç¼“å†²åŒºä¿¡æ¯è·å– - äº†è§£å†…æ ¸DMAç¼“å†²åŒºé…ç½®
    printf("\nğŸ’¾ 2. æ­£åœ¨æŸ¥è¯¢ç¼“å†²åŒºé…ç½®...\n");
    printf("   ğŸ“‹ ç”¨é€”ï¼šè·å–å†…æ ¸åˆ†é…çš„DMAç¼“å†²åŒºå‚æ•°\n");
    printf("   ğŸ”§ IOCTLå‘½ä»¤ï¼šDATABUS_IOCTL_GET_BUFFER_INFO\n");
    
    if (ioctl(g_fd, DATABUS_IOCTL_GET_BUFFER_INFO, &buffer_info) < 0) {
        fprintf(stderr, "âŒ ç¼“å†²åŒºä¿¡æ¯è·å–å¤±è´¥\n");
        fprintf(stderr, "ğŸ’¡ å¯èƒ½åŸå› ï¼šå†…æ ¸æ¨¡å—åˆå§‹åŒ–æœªå®Œæˆæˆ–å†…å­˜ä¸è¶³\n");
        cleanup_resources();
        return EXIT_FAILURE;
    }
    
    printf("   âœ… ç¼“å†²åŒºé…ç½®è·å–æˆåŠŸï¼š\n");
    printf("   ğŸ“ æ€»ç¼“å†²åŒºå¤§å°: %lu å­—èŠ‚ (%.2f MB)\n", 
           buffer_info.dma_buffer_size, buffer_info.dma_buffer_size / (1024.0 * 1024.0));
    printf("   ğŸ“¦ æ•°æ®åŒ…å®¹é‡: %u ä¸ª\n", buffer_info.max_packets);
    printf("   ğŸ“‹ å•åŒ…å¤§å°: %u å­—èŠ‚\n", buffer_info.packet_size);
    printf("   ğŸ—‚ï¸ å†…å­˜å¸ƒå±€ï¼š\n");
    printf("      â”œâ”€â”€ å¤´éƒ¨åç§»: %lu (ç¯å½¢ç¼“å†²åŒºæ§åˆ¶ç»“æ„)\n", buffer_info.header_offset);
    printf("      â”œâ”€â”€ å…ƒæ•°æ®åç§»: %lu (AIæ•°æ®åŒ…å…ƒæ•°æ®æ•°ç»„)\n", buffer_info.metadata_offset);
    printf("      â””â”€â”€ æ•°æ®åç§»: %lu (å®é™…ä¼ æ„Ÿå™¨æ•°æ®åŒºåŸŸ)\n", buffer_info.data_offset);
    printf("   ğŸ”„ ç¯å½¢ç¼“å†²åŒº: æ”¯æŒæ— é”å¹¶å‘è®¿é—®\n");
    
    // ğŸ—ºï¸ 3. DMAç¼“å†²åŒºå†…å­˜æ˜ å°„ - å®ç°é›¶æ‹·è´æ•°æ®è®¿é—®
    printf("\nğŸ—ºï¸ 3. æ­£åœ¨å»ºç«‹å†…å­˜æ˜ å°„...\n");
    printf("   ğŸ“‹ æŠ€æœ¯ï¼šmmapç³»ç»Ÿè°ƒç”¨å®ç°é›¶æ‹·è´è®¿é—®\n");
    printf("   ğŸ¯ ç›®æ ‡ï¼šå°†å†…æ ¸DMAç¼“å†²åŒºæ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´\n");
    printf("   ğŸ”§ æƒé™ï¼šåªè¯»è®¿é—® (PROT_READ)\n");
    printf("   ğŸ”— å…±äº«æ¨¡å¼ï¼šMAP_SHARED (ä¸å†…æ ¸å…±äº«å†…å­˜)\n");
    
    g_mapped_size = buffer_info.dma_buffer_size;
    g_mapped_buffer = mmap(NULL, g_mapped_size, PROT_READ, MAP_SHARED, g_fd, 0);
    if (g_mapped_buffer == MAP_FAILED) {
        fprintf(stderr, "âŒ DMAç¼“å†²åŒºæ˜ å°„å¤±è´¥: %s\n", strerror(errno));
        fprintf(stderr, "ğŸ’¡ æ•…éšœæ’é™¤ï¼š\n");
        fprintf(stderr, "   1. æ£€æŸ¥å¯ç”¨å†…å­˜: free -h\n");
        fprintf(stderr, "   2. æ£€æŸ¥å†…æ ¸æ¨¡å—çŠ¶æ€: dmesg | grep databus\n");
        fprintf(stderr, "   3. éªŒè¯è®¾å¤‡æ–‡ä»¶æƒé™\n");
        cleanup_resources();
        return EXIT_FAILURE;
    }
    
    printf("   âœ… å†…å­˜æ˜ å°„å»ºç«‹æˆåŠŸï¼š\n");
    printf("   ğŸ“ è™šæ‹Ÿåœ°å€: %p\n", g_mapped_buffer);
    printf("   ğŸ“ æ˜ å°„å¤§å°: %zu å­—èŠ‚ (%.2f MB)\n", g_mapped_size, g_mapped_size / (1024.0 * 1024.0));
    printf("   âš¡ é›¶æ‹·è´è®¿é—®: ç”¨æˆ·ç©ºé—´ç›´æ¥è¯»å–å†…æ ¸DMAç¼“å†²åŒº\n");
    printf("   ğŸ”’ å†…å­˜ä¿æŠ¤: åªè¯»æƒé™ï¼Œé˜²æ­¢æ„å¤–ä¿®æ”¹\n");
    
    // ğŸ¯ 4. ç¼“å†²åŒºæŒ‡é’ˆåˆå§‹åŒ– - å»ºç«‹æ•°æ®ç»“æ„è®¿é—®è·¯å¾„
    printf("\nğŸ¯ 4. æ­£åœ¨åˆå§‹åŒ–ç¼“å†²åŒºè®¿é—®æŒ‡é’ˆ...\n");
    printf("   ğŸ“‹ ç›®çš„ï¼šå»ºç«‹å¯¹æ˜ å°„å†…å­˜ä¸­å„æ•°æ®ç»“æ„çš„ç›´æ¥è®¿é—®\n");
    printf("   ğŸ—ï¸ å†…å­˜å¸ƒå±€è§£æï¼š\n");
    
    // è®¡ç®—å„æ•°æ®ç»“æ„çš„å†…å­˜åœ°å€
    ring_header = (struct ring_buffer_header *)((char *)g_mapped_buffer + buffer_info.header_offset);
    packet_metadata = (struct ai_data_packet *)((char *)g_mapped_buffer + buffer_info.metadata_offset);
    
    printf("   âœ… æŒ‡é’ˆåˆå§‹åŒ–å®Œæˆï¼š\n");
    printf("   ğŸ”„ ç¯å½¢ç¼“å†²åŒºæ§åˆ¶å¤´: %p (åç§»: +%lu)\n", ring_header, buffer_info.header_offset);
    printf("      â”œâ”€â”€ åŒ…å«ç”Ÿäº§è€…/æ¶ˆè´¹è€…æŒ‡é’ˆ\n");
    printf("      â”œâ”€â”€ ç¼“å†²åŒºçŠ¶æ€æ ‡å¿—\n");
    printf("      â””â”€â”€ åŒæ­¥å’Œç»Ÿè®¡ä¿¡æ¯\n");
    printf("   ğŸ“¦ AIæ•°æ®åŒ…å…ƒæ•°æ®æ•°ç»„: %p (åç§»: +%lu)\n", packet_metadata, buffer_info.metadata_offset);
    printf("      â”œâ”€â”€ IMUä¼ æ„Ÿå™¨æ•°æ®æè¿°\n");
    printf("      â”œâ”€â”€ å¼ é‡æ•°æ®æè¿°ç¬¦\n");
    printf("      â””â”€â”€ æ—¶é—´æˆ³å’Œåºåˆ—å·\n");
    
    // âš™ï¸ 5. I/Oæ¨¡å¼é…ç½® - é€‰æ‹©æ•°æ®è®¿é—®ç­–ç•¥
    printf("\nâš™ï¸ 5. é…ç½®I/Oè®¿é—®æ¨¡å¼...\n");
    printf("   ğŸ“‹ å½“å‰æ¨¡å¼ï¼šæ ‡å‡†åŒæ­¥I/O\n");
    printf("   ğŸ”§ å¼‚æ­¥I/O (io_uring): å·²ç¦ç”¨ (å¯é€‰åŠŸèƒ½)\n");
    printf("   ğŸ’¡ è¯´æ˜ï¼šæ ‡å‡†æ¨¡å¼é€‚åˆå¤§å¤šæ•°åº”ç”¨åœºæ™¯\n");
    // if (io_uring_queue_init(32, &g_ring, 0) < 0) {
    //     perror("io_uringåˆå§‹åŒ–å¤±è´¥");
    //     cleanup_resources();
    //     return EXIT_FAILURE;
    // }
    // g_ring_initialized = 1;
    printf("   âœ… I/Oæ¨¡å¼é…ç½®å®Œæˆ\n");
    
    // ğŸš€ 6. æ•°æ®æµå¯åŠ¨ - æ¿€æ´»å†…æ ¸æ•°æ®ç”Ÿæˆå¼•æ“
    printf("\nğŸš€ 6. æ­£åœ¨å¯åŠ¨AIæ•°æ®æµ...\n");
    printf("   ğŸ“‹ åŠŸèƒ½ï¼šé€šçŸ¥å†…æ ¸å¼€å§‹AIæ•°æ®ç”Ÿæˆå’ŒDMAä¼ è¾“\n");
    printf("   ğŸ”§ IOCTLå‘½ä»¤ï¼šDATABUS_IOCTL_START_STREAM\n");
    printf("   âš¡ æ•ˆæœï¼šæ¿€æ´»å†…æ ¸çº¿ç¨‹ï¼Œå¼€å§‹é«˜é¢‘æ•°æ®é‡‡é›†\n");
    
    if (ioctl(g_fd, DATABUS_IOCTL_START_STREAM, NULL) < 0) {
        fprintf(stderr, "âŒ æ•°æ®æµå¯åŠ¨å¤±è´¥: %s\n", strerror(errno));
        fprintf(stderr, "ğŸ’¡ å¯èƒ½åŸå› ï¼š\n");
        fprintf(stderr, "   1. å†…æ ¸çº¿ç¨‹åˆ›å»ºå¤±è´¥\n");
        fprintf(stderr, "   2. DMAç¼“å†²åŒºæœªå°±ç»ª\n");
        fprintf(stderr, "   3. ç¡¬ä»¶èµ„æºä¸è¶³\n");
        cleanup_resources();
        return EXIT_FAILURE;
    }
    
    printf("   âœ… æ•°æ®æµå¯åŠ¨æˆåŠŸï¼\n");
    printf("   ğŸ”¥ å†…æ ¸AIæ•°æ®ç”Ÿæˆå¼•æ“å·²æ¿€æ´»\n");
    printf("   ğŸ“Š å¼€å§‹é«˜é¢‘æ•°æ®é‡‡é›† (1000 Hz)\n");
    printf("   âš¡ DMAé›¶æ‹·è´ä¼ è¾“å·²å°±ç»ª\n");
    
    // ğŸ“Š 7. å®æ—¶æ•°æ®å¤„ç†ä¸»å¾ªç¯ - é«˜æ€§èƒ½AIæ•°æ®æµå¤„ç†å¼•æ“
    printf("\nğŸ“Š 7. å¯åŠ¨å®æ—¶æ•°æ®å¤„ç†å¼•æ“...\n");
    printf("========================================================\n");
    printf("ğŸ¯ å¤„ç†æ¨¡å¼ï¼šé›¶æ‹·è´ç¯å½¢ç¼“å†²åŒºè½®è¯¢\n");
    printf("âš¡ æ€§èƒ½ç›®æ ‡ï¼šå¾®ç§’çº§å»¶è¿Ÿï¼ŒåƒåŒ…/ç§’ååé‡\n");
    printf("ğŸ›‘ åœæ­¢æ–¹å¼ï¼šæŒ‰ Ctrl+C ä¼˜é›…å…³é—­\n");
    printf("ğŸ“‹ æ•°æ®æµå‘ï¼šå†…æ ¸DMA â†’ ç¯å½¢ç¼“å†²åŒº â†’ ç”¨æˆ·ç©ºé—´å¤„ç†\n");
    printf("========================================================\n");
    
    // â±ï¸ æ€§èƒ½ç»Ÿè®¡å’ŒçŠ¶æ€åˆå§‹åŒ–
    start_time = time(NULL);
    last_tail = ring_header->tail;  // è®°å½•åˆå§‹æ¶ˆè´¹è€…ä½ç½®
    printf("â±ï¸ æ€§èƒ½ç›‘æ§å·²å¯åŠ¨ï¼Œç»Ÿè®¡å‘¨æœŸï¼š5ç§’\n");
    printf("ğŸ”„ åˆå§‹ç¼“å†²åŒºçŠ¶æ€ï¼šå°¾æŒ‡é’ˆ=%u\n", last_tail);
    
    // ğŸ”„ ä¸»å¤„ç†å¾ªç¯ - é«˜æ•ˆçš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼å®ç°
    printf("ğŸ”„ è¿›å…¥ä¸»å¤„ç†å¾ªç¯...\n\n");
    while (g_running) {
        // ğŸ“ è¯»å–ç¯å½¢ç¼“å†²åŒºå½“å‰çŠ¶æ€ï¼ˆåŸå­æ“ä½œï¼‰
        uint32_t current_head = ring_header->head;  // ç”Ÿäº§è€…æŒ‡é’ˆï¼ˆå†…æ ¸å†™å…¥ä½ç½®ï¼‰
        uint32_t current_tail = last_tail;          // æ¶ˆè´¹è€…æŒ‡é’ˆï¼ˆç”¨æˆ·è¯»å–ä½ç½®ï¼‰
        
        // ğŸ” æ£€æµ‹æ–°æ•°æ®å¯ç”¨æ€§ - æ— é”å¹¶å‘æ£€æŸ¥
        // ç®—æ³•åŸç†ï¼šå½“head != tailæ—¶ï¼Œè¡¨ç¤ºæœ‰æ–°æ•°æ®åŒ…å¯ä¾›å¤„ç†
        if (current_head != current_tail) {
            // ğŸ“¦ æ‰¹é‡å¤„ç†æ–°åˆ°è¾¾çš„æ•°æ®åŒ…
            // ä¼˜åŒ–ç­–ç•¥ï¼šä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰å¯ç”¨æ•°æ®ï¼Œå‡å°‘ç³»ç»Ÿè°ƒç”¨å¼€é”€
            while (current_tail != current_head) {
                // ğŸ¯ è·å–å½“å‰æ•°æ®åŒ…çš„å…ƒæ•°æ®æŒ‡é’ˆ
                // å†…å­˜è®¿é—®ï¼šç›´æ¥ä»æ˜ å°„çš„DMAç¼“å†²åŒºè¯»å–ï¼Œé›¶æ‹·è´æ“ä½œ
                const struct ai_data_packet *pkt = &packet_metadata[current_tail];
                
                // ğŸ“Š å®æ—¶æ•°æ®åŒ…ä¿¡æ¯æ˜¾ç¤ºå’ŒéªŒè¯
                // åŠŸèƒ½ï¼šè§£æIMUæ•°æ®ã€æ—¶é—´æˆ³ã€åºåˆ—å·ç­‰å…³é”®ä¿¡æ¯
                display_packet_info(pkt);
                
                // ğŸ“ˆ æ›´æ–°å¤„ç†ç»Ÿè®¡è®¡æ•°å™¨
                packets_processed++;
                
                // ğŸ”„ æ›´æ–°æ¶ˆè´¹è€…æŒ‡é’ˆï¼ˆå¤„ç†ç¯å½¢ç¼“å†²åŒºå›ç»•ï¼‰
                // ç®—æ³•ï¼šæ¨¡è¿ç®—ç¡®ä¿æŒ‡é’ˆåœ¨æœ‰æ•ˆèŒƒå›´å†…å¾ªç¯
                current_tail = (current_tail + 1) % buffer_info.max_packets;
            }
            
            // ğŸ”„ åŒæ­¥æ›´æ–°ç¯å½¢ç¼“å†²åŒºçš„æ¶ˆè´¹è€…æŒ‡é’ˆ
            // é‡è¦ï¼šé€šçŸ¥å†…æ ¸å½“å‰ç”¨æˆ·ç©ºé—´çš„å¤„ç†è¿›åº¦
            ring_header->tail = current_tail;
            last_tail = current_tail;
        } else {
            // ğŸ˜´ æ— æ–°æ•°æ®æ—¶çš„CPUå‹å¥½ç­‰å¾…ç­–ç•¥
            // ä¼˜åŒ–ï¼šé¿å…å¿™ç­‰å¾…ï¼Œå‡å°‘CPUå ç”¨ç‡
            usleep(1000); // 1æ¯«ç§’ä¼‘çœ ï¼Œå¹³è¡¡å»¶è¿Ÿå’Œæ€§èƒ½
        }
        
        // ğŸ“Š å®šæœŸæ€§èƒ½ç»Ÿè®¡æŠ¥å‘Šï¼ˆæ¯5ç§’ä¸€æ¬¡ï¼‰
        // ç›®çš„ï¼šç›‘æ§ç³»ç»Ÿååé‡ã€å»¶è¿Ÿå’Œç¼“å†²åŒºå¥åº·çŠ¶æ€
        current_time = time(NULL);
        if (current_time - start_time >= 5) {
            // ğŸ“ˆ è®¡ç®—æ€§èƒ½æŒ‡æ ‡
            double elapsed = difftime(current_time, start_time);  // å®é™…è¿è¡Œæ—¶é—´
            double fps = packets_processed / elapsed;             // å¹³å‡å¤„ç†å¸§ç‡
            
            // ğŸ“‹ è¯¦ç»†æ€§èƒ½æŠ¥å‘Šè¾“å‡º
            printf("\nğŸ”¥ === æ€§èƒ½ç»Ÿè®¡æŠ¥å‘Š ===\n");
            printf("â±ï¸ è¿è¡Œæ—¶é—´: %.1f ç§’\n", elapsed);
            printf("ğŸ“¦ å·²å¤„ç†æ•°æ®åŒ…: %u ä¸ª\n", packets_processed);
            printf("âš¡ å¹³å‡å¤„ç†é€Ÿåº¦: %.2f åŒ…/ç§’ (%.2f FPS)\n", fps, fps);
            printf("ğŸ”„ ç¯å½¢ç¼“å†²åŒºçŠ¶æ€:\n");
            printf("   â”œâ”€â”€ ç”Ÿäº§è€…æŒ‡é’ˆ(Head): %u\n", ring_header->head);
            printf("   â”œâ”€â”€ æ¶ˆè´¹è€…æŒ‡é’ˆ(Tail): %u\n", ring_header->tail);
            printf("   â””â”€â”€ ç¼“å†²åŒºåˆ©ç”¨ç‡: %.1f%%\n", 
                   ((ring_header->head - ring_header->tail + buffer_info.max_packets) % buffer_info.max_packets) * 100.0 / buffer_info.max_packets);
            printf("ğŸ’¾ å†…å­˜æ˜ å°„çŠ¶æ€: æ­£å¸¸ (%.2f MB)\n", g_mapped_size / (1024.0 * 1024.0));
            printf("========================\n\n");
            
            // ğŸ”„ é‡ç½®ç»Ÿè®¡è®¡æ•°å™¨ï¼Œå¼€å§‹æ–°çš„ç»Ÿè®¡å‘¨æœŸ
            start_time = current_time;
            packets_processed = 0;
        }
    }
    
    // ğŸ›‘ 8. ä¼˜é›…å…³é—­å’Œèµ„æºæ¸…ç† - ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§
    printf("\n\nğŸ›‘ 8. æ£€æµ‹åˆ°é€€å‡ºä¿¡å·ï¼Œå¼€å§‹ä¼˜é›…å…³é—­...\n");
    printf("========================================================\n");
    printf("ğŸ”„ æ­£åœ¨åœæ­¢æ•°æ®æµ...\n");
    
    // ğŸš« åœæ­¢å†…æ ¸æ•°æ®æµ
    if (ioctl(g_fd, DATABUS_IOCTL_STOP_STREAM) < 0) {
        fprintf(stderr, "âš ï¸ æ•°æ®æµåœæ­¢å¤±è´¥ï¼Œä½†ç»§ç»­æ¸…ç†èµ„æº\n");
    } else {
        printf("âœ… æ•°æ®æµå·²å®‰å…¨åœæ­¢\n");
    }
    
    printf("ğŸ§¹ æ­£åœ¨æ¸…ç†ç³»ç»Ÿèµ„æº...\n");
    cleanup_resources();
    
    printf("\nğŸ‰ DataBus AI Engine å®¢æˆ·ç«¯å·²å®‰å…¨é€€å‡º\n");
    printf("ğŸ“Š ä¼šè¯æ€»ç»“ï¼šæˆåŠŸæ¼”ç¤ºäº†é›¶æ‹·è´ã€é«˜æ€§èƒ½çš„AIæ•°æ®å¤„ç†\n");
    printf("ğŸ’¡ æŠ€æœ¯äº®ç‚¹ï¼šDMAç¼“å†²åŒºã€ç¯å½¢ç¼“å†²åŒºã€mmapæ˜ å°„ã€å®æ—¶å¤„ç†\n");
    printf("========================================================\n");
    
    return EXIT_SUCCESS;
}